<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DroneCommand Pro - Ground Control Station</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #0066cc;
            --secondary: #1a2735;
            --accent: #00d4ff;
            --danger: #e74c3c;
            --success: #2ecc71;
            --dark: #0c1521;
            --light: #f8f9fa;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--dark);
            color: var(--light);
            height: 100vh;
            overflow: hidden;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            gap: 10px;
            padding: 10px;
            overflow: hidden;
        }
        
        /* Left Control Panel */
        .control-panel {
            width: 280px;
            background: var(--secondary);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }
        
        .panel-section {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 15px;
        }
        
        .section-title {
            font-size: 14px;
            color: var(--accent);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-height: 60px;
            justify-content: center;
        }
        
        .btn:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: var(--primary);
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn i { font-size: 16px; }
        
        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: hidden;
            min-width: 0;
        }
        
        .top-row {
            display: flex;
            gap: 10px;
            height: 50%;
            min-height: 300px;
            flex-shrink: 0;
        }
        
        .map-container, .video-container {
            flex: 1;
            background: var(--secondary);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            min-width: 0;
        }
        
        .container-header {
            padding: 15px;
            background: rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .container-body {
            padding: 20px;
            height: calc(100% - 60px);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            overflow: auto;
        }
        
        .bottom-row {
            display: flex;
            gap: 10px;
            height: 50%;
            min-height: 300px;
            flex: 1;
            overflow: hidden;
        }
        
        /* Telemetry Panel */
        .telemetry-panel {
            width: 300px;
            background: var(--secondary);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .telemetry-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .telemetry-card {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .telemetry-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--accent);
            margin: 5px 0;
            line-height: 1.2;
        }
        
        .telemetry-label {
            font-size: 11px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Mission Panel */
        .mission-panel {
            flex: 1;
            background: var(--secondary);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        
        .mission-content {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* Status Bar */
        .status-bar {
            background: var(--secondary);
            border-radius: 12px;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            margin-top: auto;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--danger);
        }
        
        .status-dot.connected { background: var(--success); }
        
        /* VR Mode Toggle */
        .vr-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }
        
        .vr-btn {
            background: linear-gradient(45deg, #8a2be2, #00d4ff);
            border: none;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 4px 15px rgba(138, 43, 226, 0.4);
            transition: all 0.3s;
        }
        
        .vr-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(138, 43, 226, 0.6);
        }
        
        /* Fullscreen button */
        .fullscreen-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .fullscreen-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }
        
        /* Keyboard overlay styles */
        .key-help {
            padding: 6px 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.2s;
            user-select: none;
        }
        
        .key-help:hover {
            background: rgba(255,255,255,0.15);
            border-color: var(--accent);
        }
        
        .active-key {
            background: var(--primary) !important;
            color: white !important;
            box-shadow: 0 0 10px var(--primary);
        }
        
        @keyframes pulseKey {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .key-pulse {
            animation: pulseKey 0.3s ease;
        }
        
        /* Camera specific styles */
        #camera-frame {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
            border-radius: 8px;
        }
        
        .camera-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 10;
        }
        
        .camera-btn {
            background: rgba(0,0,0,0.7);
            border: 1px solid var(--accent);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .camera-btn:hover {
            background: var(--primary);
        }
        
        .camera-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .camera-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        .camera-loading-spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Left Control Panel -->
        <div class="control-panel">
            <div class="panel-section">
                <div class="section-title"><i class="fas fa-rocket"></i> Flight Controls</div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="sendCommand('takeoff')">
                        <i class="fas fa-plane-departure"></i> Takeoff
                    </button>
                    <button class="btn btn-danger" onclick="sendCommand('land')">
                        <i class="fas fa-plane-arrival"></i> Land
                    </button>
                    <button class="btn btn-primary" onclick="sendCommand('rth')">
                        <i class="fas fa-home"></i> RTH
                    </button>
                    <button class="btn" onclick="sendCommand('hold')">
                        <i class="fas fa-pause"></i> Hold
                    </button>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="section-title"><i class="fas fa-gamepad"></i> Manual Control</div>
                <div class="btn-group">
                    <button class="btn" onclick="sendCommand('forward')">
                        <i class="fas fa-arrow-up"></i> Forward
                    </button>
                    <button class="btn" onclick="sendCommand('backward')">
                        <i class="fas fa-arrow-down"></i> Back
                    </button>
                    <button class="btn" onclick="sendCommand('left')">
                        <i class="fas fa-arrow-left"></i> Left
                    </button>
                    <button class="btn" onclick="sendCommand('right')">
                        <i class="fas fa-arrow-right"></i> Right
                    </button>
                    <button class="btn" onclick="sendCommand('up')">
                        <i class="fas fa-angle-up"></i> Up
                    </button>
                    <button class="btn" onclick="sendCommand('down')">
                        <i class="fas fa-angle-down"></i> Down
                    </button>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="section-title"><i class="fas fa-cogs"></i> Auto Modes</div>
                <div class="btn-group">
                    <button class="btn" onclick="activateMode('grid')">
                        <i class="fas fa-th"></i> Grid Scan
                    </button>
                    <button class="btn" onclick="activateMode('perimeter')">
                        <i class="fas fa-draw-polygon"></i> Perimeter
                    </button>
                    <button class="btn" onclick="activateMode('follow')">
                        <i class="fas fa-satellite"></i> Follow
                    </button>
                    <button class="btn" onclick="openMissionPlanner()">
                        <i class="fas fa-map-marked-alt"></i> Mission
                    </button>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="section-title"><i class="fas fa-sliders-h"></i> Camera Controls</div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button class="btn" onclick="startCameraStream()">
                        <i class="fas fa-play"></i> Start Stream
                    </button>
                    <button class="btn" onclick="stopCameraStream()">
                        <i class="fas fa-stop"></i> Stop Stream
                    </button>
                    <button class="btn" onclick="toggleCameraQuality()">
                        <i class="fas fa-cog"></i> Toggle Quality
                    </button>
                    <button class="btn" onclick="takeSnapshot()">
                        <i class="fas fa-camera"></i> Take Snapshot
                    </button>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="section-title"><i class="fas fa-sliders-h"></i> Display</div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button class="btn" onclick="toggleFullscreen('map-area')">
                        <i class="fas fa-expand"></i> Fullscreen Map
                    </button>
                    <button class="btn" onclick="toggleFullscreen('video-container')">
                        <i class="fas fa-expand"></i> Fullscreen Video
                    </button>
                    <button class="btn" onclick="clearLogs()">
                        <i class="fas fa-trash"></i> Clear Logs
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <div class="top-row">
                <div class="map-container">
                    <div class="container-header">
                        <h3><i class="fas fa-map"></i> Live Flight Map</h3>
                        <div class="map-controls">
                            <button class="fullscreen-btn" onclick="toggleFullscreen(this.closest('.map-container'))">
                                <i class="fas fa-expand"></i> Fullscreen
                            </button>
                        </div>
                    </div>
                    <div class="container-body" id="map-area">
                        <div style="text-align: center; max-width: 400px;">
                            <i class="fas fa-map-marked-alt" style="font-size: 48px; color: #444; margin-bottom: 15px;"></i>
                            <h3 style="margin-bottom: 10px;">Interactive Flight Map</h3>
                            <p style="color: #666; margin: 10px 0;">Google Maps integration ready for drone tracking</p>
                            <div style="margin-top: 20px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                <p style="font-size: 12px; color: #777;">
                                    <i class="fas fa-info-circle"></i> 
                                    Will show real-time drone position, flight path, and waypoints
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="video-container" id="video-container">
                    <div class="container-header">
                        <h3><i class="fas fa-video"></i> Live Camera Feed</h3>
                        <div>
                            <button class="fullscreen-btn" onclick="toggleFullscreen(this.closest('.video-container'))">
                                <i class="fas fa-expand"></i> Fullscreen
                            </button>
                            <button class="fullscreen-btn" onclick="refreshCameraStream()" style="margin-left: 8px;">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="container-body" id="video-feed">
                        <!-- Camera feed will be loaded here -->
                        <div class="camera-loading" id="camera-loading">
                            <div class="camera-loading-spinner"></div>
                            <h3 style="margin-bottom: 10px;">Loading Camera Stream</h3>
                            <p style="color: #666; margin: 10px 0; max-width: 400px; text-align: center;">
                                Connecting to ESP32-CAM video stream via server...
                            </p>
                            <button class="btn" style="margin-top: 20px;" onclick="startCameraStream()">
                                <i class="fas fa-play"></i> Start Camera Stream
                            </button>
                        </div>
                    </div>
                    <div class="camera-controls" id="camera-controls" style="display: none;">
                        <button class="camera-btn" onclick="takeSnapshot()">
                            <i class="fas fa-camera"></i> Snapshot
                        </button>
                        <button class="camera-btn" onclick="toggleCameraQuality()" id="quality-btn">
                            <i class="fas fa-tachometer-alt"></i> Quality: Normal
                        </button>
                        <button class="camera-btn" onclick="toggleRecording()" id="record-btn">
                            <i class="fas fa-circle"></i> Start Record
                        </button>
                    </div>
                    <div class="camera-status" id="camera-status" style="display: none;">
                        <i class="fas fa-wifi"></i>
                        <span id="camera-status-text">Connected</span>
                    </div>
                </div>
            </div>
            
            <div class="bottom-row">
                <div class="telemetry-panel">
                    <div class="section-title"><i class="fas fa-chart-line"></i> Telemetry Dashboard</div>
                    
                    <div class="telemetry-grid">
                        <div class="telemetry-card">
                            <div class="telemetry-label">GPS Position</div>
                            <div class="telemetry-value" id="gps-value">33.642°N<br>73.072°E</div>
                        </div>
                        <div class="telemetry-card">
                            <div class="telemetry-label">Altitude</div>
                            <div class="telemetry-value" id="altitude-value">45.2 m</div>
                        </div>
                        <div class="telemetry-card">
                            <div class="telemetry-label">Battery</div>
                            <div class="telemetry-value" id="battery-value">87%</div>
                        </div>
                        <div class="telemetry-card">
                            <div class="telemetry-label">Speed</div>
                            <div class="telemetry-value" id="speed-value">5.2 m/s</div>
                        </div>
                        <div class="telemetry-card">
                            <div class="telemetry-label">Signal</div>
                            <div class="telemetry-value" id="signal-value">-72 dBm</div>
                        </div>
                        <div class="telemetry-card">
                            <div class="telemetry-label">Flight Time</div>
                            <div class="telemetry-value" id="time-value">12:34</div>
                        </div>
                    </div>
                    
                    <div class="panel-section">
                        <div class="section-title"><i class="fas fa-microchip"></i> System Status</div>
                        <div style="font-size: 13px; line-height: 1.6;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>Flight Controller:</span>
                                <span id="fc-status" style="color: var(--danger);">● Offline</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>4G Link:</span>
                                <span id="link-status" style="color: var(--danger);">● Disconnected</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>Video Stream:</span>
                                <span id="video-status" style="color: var(--danger);">● Offline</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>GPS Lock:</span>
                                <span id="gps-status" style="color: var(--danger);">● No Lock</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mission-panel">
                    <div class="container-header">
                        <h3><i class="fas fa-tasks"></i> Mission Planner & Flight Logs</h3>
                        <div>
                            <button class="fullscreen-btn" onclick="toggleFullscreen(this.closest('.mission-panel'))">
                                <i class="fas fa-expand"></i> Fullscreen
                            </button>
                        </div>
                    </div>
                    <div class="mission-content">
                        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                            <h4 style="margin-bottom: 10px; color: var(--accent);">Active Mission</h4>
                            <p style="font-size: 13px; color: #aaa; margin-bottom: 15px;">
                                No mission loaded. Create waypoint missions for autonomous flight.
                            </p>
                            <button class="btn" style="padding: 8px 15px; width: auto;" onclick="loadSampleMission()">
                                <i class="fas fa-download"></i> Load Sample Mission
                            </button>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; flex: 1; display: flex; flex-direction: column;">
                            <h4 style="margin-bottom: 10px; color: var(--accent);">Flight Log</h4>
                            <div id="log-entries" style="font-size: 12px; color: #aaa; line-height: 1.8; flex: 1; overflow-y: auto;">
                                <div>12:05:32 - GCS System initialized</div>
                                <div>12:05:45 - Ground Control Station ready</div>
                                <div>12:06:10 - WebSocket server connected</div>
                                <div>12:06:30 - Waiting for drone connection</div>
                            </div>
                            <button class="btn" style="margin-top: 10px; padding: 8px; font-size: 12px;" onclick="clearLogs()">
                                <i class="fas fa-broom"></i> Clear All Logs
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- VR Mode Toggle -->
    <div class="vr-toggle">
        <button class="vr-btn" onclick="toggleVRMode()" title="Toggle VR Mode">
            <i class="fas fa-vr-cardboard"></i>
        </button>
    </div>
    
    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-indicator">
            <div class="status-dot" id="status-dot"></div>
            <span id="connection-status">Connected to GCS Server</span>
        </div>
        <div style="font-size: 13px; color: #aaa;">
            <i class="fas fa-satellite"></i> Mini Surveillance Drone v1.0 | 
            <span id="server-status" style="color: var(--success);">Operational</span> |
            <span id="camera-latency">Cam: -- ms</span>
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // WebSocket Connection
        const socket = io();
        let isVRMode = false;
        let cameraInterval = null;
        let isCameraStreaming = false;
        let cameraQuality = 'normal'; // normal, high, low
        let isRecording = false;
        let lastFrameTime = 0;
        const DRONE_ID = 'drone-001'; // Your drone ID
        const CAMERA_REFRESH_RATE = 200; // ms between frame updates
        
        // Connection Management
        socket.on('connect', () => {
            updateStatus('connected');
            addLog('Connected to GCS server');
        });
        
        socket.on('disconnect', () => {
            updateStatus('disconnected');
            addLog('Disconnected from server');
        });
        
        // Camera frame event from server
        socket.on('camera-frame', (data) => {
            updateCameraStatus('Receiving frames');
        });
        
        // ======================= CAMERA STREAMING SYSTEM =======================
        
        function startCameraStream() {
            if (isCameraStreaming) {
                showToast('Camera stream already running');
                return;
            }
            
            const videoFeed = document.getElementById('video-feed');
            const loadingDiv = document.getElementById('camera-loading');
            const controlsDiv = document.getElementById('camera-controls');
            const statusDiv = document.getElementById('camera-status');
            
            // Create video element
            videoFeed.innerHTML = '';
            const cameraFrame = document.createElement('img');
            cameraFrame.id = 'camera-frame';
            cameraFrame.src = ''; // Will be set by interval
            videoFeed.appendChild(cameraFrame);
            
            // Show controls and status
            loadingDiv.style.display = 'none';
            controlsDiv.style.display = 'flex';
            statusDiv.style.display = 'flex';
            
            // Start streaming
            isCameraStreaming = true;
            updateCameraStatus('Streaming...');
            document.getElementById('video-status').textContent = '● Streaming';
            document.getElementById('video-status').style.color = 'var(--success)';
            
            // Start frame update interval
            cameraInterval = setInterval(updateCameraFrame, CAMERA_REFRESH_RATE);
            
            addLog('Camera stream started');
            showToast('Camera stream started');
        }
        
        function stopCameraStream() {
            if (!isCameraStreaming) return;
            
            clearInterval(cameraInterval);
            isCameraStreaming = false;
            
            const videoFeed = document.getElementById('video-feed');
            const loadingDiv = document.getElementById('camera-loading');
            const controlsDiv = document.getElementById('camera-controls');
            const statusDiv = document.getElementById('camera-status');
            
            // Reset to loading view
            videoFeed.innerHTML = '';
            const loadingContent = loadingDiv.cloneNode(true);
            videoFeed.appendChild(loadingContent);
            
            // Hide controls and status
            loadingDiv.style.display = 'flex';
            controlsDiv.style.display = 'none';
            statusDiv.style.display = 'none';
            
            // Update status indicators
            document.getElementById('video-status').textContent = '● Offline';
            document.getElementById('video-status').style.color = 'var(--danger)';
            
            addLog('Camera stream stopped');
            showToast('Camera stream stopped');
        }
        
        function updateCameraFrame() {
            if (!isCameraStreaming) return;
            
            const cameraFrame = document.getElementById('camera-frame');
            if (!cameraFrame) return;
            
            // Get fresh frame from server with cache busting
            const timestamp = Date.now();
            const qualityParam = cameraQuality === 'high' ? '&quality=high' : 
                                cameraQuality === 'low' ? '&quality=low' : '';
            
            fetch(`/api/drone/${DRONE_ID}/camera/latest?t=${timestamp}${qualityParam}`)
                .then(response => {
                    if (response.ok) {
                        return response.blob();
                    }
                    throw new Error('Camera not available');
                })
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    cameraFrame.src = url;
                    
                    // Calculate latency
                    const now = Date.now();
                    if (lastFrameTime > 0) {
                        const latency = now - lastFrameTime;
                        document.getElementById('camera-latency').textContent = `Cam: ${latency} ms`;
                    }
                    lastFrameTime = now;
                    
                    updateCameraStatus('Live');
                })
                .catch(error => {
                    console.error('Camera fetch error:', error);
                    updateCameraStatus('Error');
                    
                    // Try to auto-reconnect after 5 seconds
                    if (isCameraStreaming) {
                        setTimeout(() => {
                            if (isCameraStreaming) {
                                addLog('Camera auto-reconnecting...');
                                updateCameraFrame();
                            }
                        }, 5000);
                    }
                });
        }
        
        function refreshCameraStream() {
            if (isCameraStreaming) {
                updateCameraFrame();
                showToast('Camera frame refreshed');
            } else {
                startCameraStream();
            }
        }
        
        function toggleCameraQuality() {
            const qualityBtn = document.getElementById('quality-btn');
            
            if (cameraQuality === 'normal') {
                cameraQuality = 'high';
                qualityBtn.innerHTML = '<i class="fas fa-tachometer-alt"></i> Quality: High';
                showToast('Camera quality: High (more detail)');
            } else if (cameraQuality === 'high') {
                cameraQuality = 'low';
                qualityBtn.innerHTML = '<i class="fas fa-tachometer-alt"></i> Quality: Low';
                showToast('Camera quality: Low (faster)');
            } else {
                cameraQuality = 'normal';
                qualityBtn.innerHTML = '<i class="fas fa-tachometer-alt"></i> Quality: Normal';
                showToast('Camera quality: Normal');
            }
            
            addLog(`Camera quality changed to: ${cameraQuality}`);
        }
        
        function takeSnapshot() {
            if (!isCameraStreaming) {
                showToast('Start camera stream first');
                return;
            }
            
            const cameraFrame = document.getElementById('camera-frame');
            if (!cameraFrame || !cameraFrame.src) return;
            
            // Create download link
            const link = document.createElement('a');
            link.href = cameraFrame.src;
            link.download = `drone-snapshot-${Date.now()}.jpg`;
            link.click();
            
            addLog('Snapshot saved');
            showToast('Snapshot saved');
        }
        
        function toggleRecording() {
            const recordBtn = document.getElementById('record-btn');
            
            if (!isRecording) {
                isRecording = true;
                recordBtn.innerHTML = '<i class="fas fa-square"></i> Stop Record';
                recordBtn.style.background = 'var(--danger)';
                addLog('Video recording started');
                showToast('Recording started');
            } else {
                isRecording = false;
                recordBtn.innerHTML = '<i class="fas fa-circle"></i> Start Record';
                recordBtn.style.background = '';
                addLog('Video recording stopped');
                showToast('Recording stopped');
            }
        }
        
        function updateCameraStatus(status) {
            const statusText = document.getElementById('camera-status-text');
            const statusIcon = document.querySelector('#camera-status i');
            
            statusText.textContent = status;
            
            if (status === 'Live' || status === 'Streaming...') {
                statusText.style.color = 'var(--success)';
                statusIcon.className = 'fas fa-wifi';
            } else if (status === 'Error') {
                statusText.style.color = 'var(--danger)';
                statusIcon.className = 'fas fa-exclamation-triangle';
            } else {
                statusText.style.color = '#aaa';
                statusIcon.className = 'fas fa-wifi';
            }
        }
        
        // Check camera status on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                fetch(`/api/drone/${DRONE_ID}/camera/status`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.streaming) {
                            addLog('Camera stream detected - auto-starting');
                            setTimeout(startCameraStream, 1000);
                        }
                    })
                    .catch(() => {
                        // Camera not available yet
                    });
            }, 2000);
        });
        
        // ======================= ORIGINAL FUNCTIONS (UNCHANGED) =======================
        
        // Command Functions
        function sendCommand(cmd) {
            socket.emit('command', {type: 'flight', command: cmd});
            console.log('Flight command sent:', cmd);
            addLog(`Command: ${cmd.toUpperCase()}`);
            showToast(`Sent: ${cmd}`);
        }
        
        function activateMode(mode) {
            socket.emit('command', {type: 'auto', mode: mode});
            console.log('Auto mode activated:', mode);
            addLog(`Auto mode: ${mode}`);
            showToast(`Activated: ${mode} mode`);
        }
        
        // Fullscreen Functionality
        function toggleFullscreen(element) {
            if (typeof element === 'string') {
                element = document.getElementById(element);
            }
            
            if (!document.fullscreenElement) {
                if (element.requestFullscreen) {
                    element.requestFullscreen();
                } else if (element.webkitRequestFullscreen) {
                    element.webkitRequestFullscreen();
                } else if (element.msRequestFullscreen) {
                    element.msRequestFullscreen();
                }
                showToast('Entered fullscreen mode');
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                showToast('Exited fullscreen mode');
            }
        }
        
        // VR Mode
        function toggleVRMode() {
            isVRMode = !isVRMode;
            if (isVRMode) {
                document.body.classList.add('vr-mode');
                showToast('VR Mode activated');
            } else {
                document.body.classList.remove('vr-mode');
                showToast('VR Mode deactivated');
            }
        }
        
        // Mission Planner
        function openMissionPlanner() {
            addLog('Opening mission planner');
            showToast('Mission planner opening...');
        }
        
        function loadSampleMission() {
            addLog('Loading sample mission');
            showToast('Sample mission loaded');
            const missionDiv = document.querySelector('.mission-content > div:first-child');
            missionDiv.innerHTML = `
                <h4 style="margin-bottom: 10px; color: var(--accent);">Active Mission: Grid Scan</h4>
                <div style="font-size: 13px; color: #aaa; margin-bottom: 15px;">
                    <div><i class="fas fa-check-circle" style="color: var(--success);"></i> 5 Waypoints loaded</div>
                    <div><i class="fas fa-check-circle" style="color: var(--success);"></i> Altitude: 120m</div>
                    <div><i class="fas fa-check-circle" style="color: var(--success);"></i> Area: 500m x 500m</div>
                    <div><i class="fas fa-check-circle" style="color: var(--success);"></i> Estimated time: 18min</div>
                </div>
                <button class="btn btn-success" style="padding: 8px 15px; width: auto;" onclick="startMission()">
                    <i class="fas fa-play"></i> Start Mission
                </button>
            `;
        }
        
        function startMission() {
            addLog('Starting autonomous mission');
            showToast('Mission started - Autonomous flight engaged');
            sendCommand('mission_start');
        }
        
        function clearLogs() {
            document.getElementById('log-entries').innerHTML = '';
            addLog('Flight logs cleared');
            showToast('Logs cleared');
        }
        
        // Status Updates
        function updateStatus(status) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('connection-status');
            const serverStatus = document.getElementById('server-status');
            
            if (status === 'connected') {
                dot.className = 'status-dot connected';
                text.textContent = 'Connected to GCS Server';
                text.style.color = 'var(--success)';
                serverStatus.textContent = 'Operational';
                serverStatus.style.color = 'var(--success)';
                
                // Simulate drone connection after 1 second
                setTimeout(() => {
                    document.getElementById('fc-status').textContent = '● Online';
                    document.getElementById('fc-status').style.color = 'var(--success)';
                    document.getElementById('link-status').textContent = '● Connected';
                    document.getElementById('link-status').style.color = 'var(--success)';
                    document.getElementById('gps-status').textContent = '● 12 Satellites';
                    document.getElementById('gps-status').style.color = 'var(--success)';
                    addLog('Drone systems online (simulated)');
                }, 1000);
            } else {
                dot.className = 'status-dot';
                text.textContent = 'Disconnected from server';
                text.style.color = 'var(--danger)';
                serverStatus.textContent = 'Offline';
                serverStatus.style.color = 'var(--danger)';
            }
        }
        
        // Telemetry Simulation
        function simulateTelemetry() {
            if (document.getElementById('status-dot').classList.contains('connected')) {
                const battery = 85 + Math.random() * 10;
                const altitude = 40 + Math.random() * 15;
                const speed = 4 + Math.random() * 3;
                const signal = -65 - Math.random() * 20;
                
                document.getElementById('battery-value').textContent = battery.toFixed(1) + '%';
                document.getElementById('altitude-value').textContent = altitude.toFixed(1) + ' m';
                document.getElementById('speed-value').textContent = speed.toFixed(1) + ' m/s';
                document.getElementById('signal-value').textContent = signal.toFixed(0) + ' dBm';
                
                // Update time
                const now = new Date();
                document.getElementById('time-value').textContent = 
                    now.getHours().toString().padStart(2, '0') + ':' + 
                    now.getMinutes().toString().padStart(2, '0');
            }
        }
        
        // Utility Functions
        function addLog(message) {
            const logDiv = document.getElementById('log-entries');
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                           now.getMinutes().toString().padStart(2, '0') + ':' + 
                           now.getSeconds().toString().padStart(2, '0');
            
            const logEntry = document.createElement('div');
            logEntry.textContent = `${timeStr} - ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function showToast(message) {
            // Remove existing toasts
            document.querySelectorAll('.toast-message').forEach(toast => toast.remove());
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.bottom = '80px';
            toast.style.right = '20px';
            toast.style.background = 'var(--primary)';
            toast.style.color = 'white';
            toast.style.padding = '12px 20px';
            toast.style.borderRadius = '6px';
            toast.style.zIndex = '1000';
            toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
            toast.style.animation = 'fadeIn 0.3s';
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s';
                setTimeout(() => {
                    if (toast.parentNode) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        // Initialize
        setInterval(simulateTelemetry, 2000);
        updateStatus('connected');
        
        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes fadeOut {
                from { opacity: 1; transform: translateY(0); }
                to { opacity: 0; transform: translateY(10px); }
            }
        `;
        document.head.appendChild(style);
        
        // Add button click feedback
        document.querySelectorAll('.btn').forEach(btn => {
            btn.addEventListener('click', function() {
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 150);
            });
        });
        
        console.log('DroneCommand Pro GCS fully initialized with Camera Streaming');
        
        // ======================= KEYBOARD CONTROL SYSTEM =======================
        // Your existing keyboard control system remains unchanged
        // [ALL KEYBOARD CONTROL CODE REMAINS EXACTLY AS YOU HAD IT]
        
        // Key Mapping Configuration
        const keyMap = {
            'ArrowUp': 'forward',
            'ArrowDown': 'backward',
            'ArrowLeft': 'left', 
            'ArrowRight': 'right',
            'w': 'up',
            'W': 'up',
            's': 'down',
            'S': 'down',
            'a': 'yaw_left',
            'A': 'yaw_left',
            'd': 'yaw_right', 
            'D': 'yaw_right',
            ' ': 'emergency_stop',
            'Enter': 'takeoff',
            '1': 'arm',
            '2': 'disarm', 
            '3': 'rth',
            '4': 'hold',
            '5': 'grid',
            '6': 'perimeter',
            '7': 'follow',
            '8': 'mission_start',
            'Escape': 'emergency_stop',
            'F1': 'takeoff',
            'F2': 'land',
            'F3': 'rth',
            'F4': 'hold',
            'F5': 'grid', 
            'F6': 'perimeter',
            'F7': 'follow',
            'F8': 'mission_start'
        };
        
        const activeKeys = new Set();
        const commandTimers = {};
        const KEY_HOLD_INTERVAL = 200;
        
        function createKeyboardOverlay() {
            const overlay = document.createElement('div');
            overlay.id = 'keyboard-overlay';
            overlay.style.cssText = `
                position: fixed;
                bottom: 120px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(26, 39, 53, 0.95);
                border: 2px solid var(--accent);
                border-radius: 12px;
                padding: 15px;
                z-index: 9999;
                display: none;
                backdrop-filter: blur(10px);
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            `;
            
            overlay.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                    <h4 style="margin: 0; color: var(--accent);">
                        <i class="fas fa-keyboard"></i> Keyboard Controls Active
                    </h4>
                    <button id="close-keyboard-help" style="background: none; border: none; color: #aaa; cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 12px;">
                    <div class="key-help" data-key="ArrowUp">↑ Forward</div>
                    <div class="key-help" data-key="ArrowDown">↓ Backward</div>
                    <div class="key-help" data-key="ArrowLeft">← Left</div>
                    <div class="key-help" data-key="ArrowRight">→ Right</div>
                    <div class="key-help" data-key="w">W Up</div>
                    <div class="key-help" data-key="s">S Down</div>
                    <div class="key-help" data-key="a">A Yaw Left</div>
                    <div class="key-help" data-key="d">D Yaw Right</div>
                    <div class="key-help" data-key=" ">Space: Emergency</div>
                    <div class="key-help" data-key="Enter">Enter: Takeoff</div>
                    <div class="key-help" data-key="1">1: Arm</div>
                    <div class="key-help" data-key="2">2: Disarm</div>
                    <div class="key-help" data-key="3">3: RTH</div>
                    <div class="key-help" data-key="Escape">ESC: Emergency</div>
                    <div class="key-help" data-key="F1">F1: Takeoff</div>
                    <div class="key-help" data-key="F2">F2: Land</div>
                </div>
                <div style="margin-top: 10px; font-size: 11px; color: #aaa; text-align: center;">
                    Hold movement keys for continuous control | Browser tab must be active
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            document.getElementById('close-keyboard-help').addEventListener('click', () => {
                overlay.style.display = 'none';
            });
            
            return overlay;
        }
        
        const keyboardOverlay = createKeyboardOverlay();
        
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                keyboardOverlay.style.display = keyboardOverlay.style.display === 'none' ? 'block' : 'none';
            }
        });
        
        function startContinuousCommand(key, command) {
            if (commandTimers[key]) {
                clearInterval(commandTimers[key]);
            }
            
            sendCommand(command);
            showKeyPress(key, command);
            
            commandTimers[key] = setInterval(() => {
                sendCommand(command);
            }, KEY_HOLD_INTERVAL);
        }
        
        function stopContinuousCommand(key) {
            if (commandTimers[key]) {
                clearInterval(commandTimers[key]);
                delete commandTimers[key];
                
                const command = keyMap[key];
                if (['forward', 'backward', 'left', 'right', 'up', 'down', 'yaw_left', 'yaw_right'].includes(command)) {
                    setTimeout(() => {
                        sendCommand('hold');
                    }, 50);
                }
                
                showKeyRelease(key);
            }
        }
        
        function showKeyPress(key, command) {
            activeKeys.add(key);
            
            const keyElements = document.querySelectorAll(`.key-help[data-key="${key}"]`);
            keyElements.forEach(el => {
                el.style.background = 'var(--primary)';
                el.style.color = 'white';
                el.style.transform = 'scale(1.05)';
                el.style.transition = 'all 0.1s';
            });
            
            if ([' ', 'Enter', 'Escape', '1', '2', '3'].includes(key)) {
                showToast(`${command.toUpperCase()} activated`);
            }
        }
        
        function showKeyRelease(key) {
            activeKeys.delete(key);
            
            const keyElements = document.querySelectorAll(`.key-help[data-key="${key}"]`);
            keyElements.forEach(el => {
                el.style.background = '';
                el.style.color = '';
                el.style.transform = '';
            });
        }
        
        function handleKeyDown(e) {
            const preventShortcuts = [' ', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'w', 'a', 's', 'd'];
            if (preventShortcuts.includes(e.key) && !e.ctrlKey && !e.altKey && !e.metaKey) {
                e.preventDefault();
            }
            
            const command = keyMap[e.key];
            if (command && !activeKeys.has(e.key)) {
                if (['forward', 'backward', 'left', 'right', 'up', 'down', 'yaw_left', 'yaw_right'].includes(command)) {
                    startContinuousCommand(e.key, command);
                } else {
                    sendCommand(command);
                    showKeyPress(e.key, command);
                    
                    if (e.key === 'Enter') {
                        setTimeout(() => showKeyRelease(e.key), 500);
                    }
                    
                    if (['1', '2', '3', '4', '5', '6', '7', '8', 'F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8'].includes(e.key)) {
                        setTimeout(() => showKeyRelease(e.key), 300);
                    }
                }
            }
        }
        
        function handleKeyUp(e) {
            const command = keyMap[e.key];
            if (command) {
                if (['forward', 'backward', 'left', 'right', 'up', 'down', 'yaw_left', 'yaw_right'].includes(command)) {
                    stopContinuousCommand(e.key);
                } else if (![' ', 'Enter'].includes(e.key)) {
                    showKeyRelease(e.key);
                }
            }
        }
        
        function stopAllContinuousCommands() {
            Object.keys(commandTimers).forEach(key => {
                clearInterval(commandTimers[key]);
            });
            Object.keys(commandTimers).length = 0;
            activeKeys.clear();
            
            document.querySelectorAll('.key-help').forEach(el => {
                el.style.background = '';
                el.style.color = '';
                el.style.transform = '';
            });
        }
        
        function initKeyboardControls() {
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            window.addEventListener('blur', stopAllContinuousCommands);
            
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    stopAllContinuousCommands();
                }
            });
            
            console.log('🎮 Keyboard control system initialized');
            addLog('Keyboard controls enabled - Press Ctrl+K for help');
            
            setTimeout(() => {
                showToast('Keyboard controls active | Press Ctrl+K for help');
            }, 2000);
        }
        
        window.addEventListener('load', initKeyboardControls);
        
        console.log('DroneCommand Pro GCS fully initialized with Camera Streaming & Keyboard Controls');
    </script>
</body>
</html>